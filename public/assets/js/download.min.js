const id=window['location']['pathname']['split']('/')['pop'](),statusEl=document['getElementById']('status'),progressBar=document['getElementById']('progressBar');async function startDownload(){const b=document['getElementById']('password')['value'];if(!b)return alert('Passwort\x20eingeben');statusEl['textContent']='Lade\x20Datei-Metadaten...',progressBar['style']['width']='10%';const c=await fetch('/api/meta/'+id);if(!c['ok']){statusEl['textContent']='Fehler\x20beim\x20Laden\x20der\x20Metadaten.';return;}const d=await c['json'](),e=d['filename']||'file.bin';statusEl['textContent']='Lade\x20verschlüsselte\x20Datei...',progressBar['style']['width']='30%';const f=await fetch('/api/file/'+id),g=await f['arrayBuffer']();progressBar['style']['width']='50%',statusEl['textContent']='Berechne\x20Hash\x20&\x20entschlüssle...';const h=new TextEncoder(),i=await crypto['subtle']['digest']('SHA-512',h['encode'](b)),j=new Uint8Array(i)['slice'](0x0,0x20),k=await crypto['subtle']['importKey']('raw',j,{'name':'AES-GCM'},![],['decrypt']),l=new Uint8Array(g['slice'](0x0,0xc)),m=g['slice'](0xc);try{const n=await crypto['subtle']['decrypt']({'name':'AES-GCM','iv':l},k,m);progressBar['style']['width']='100%',statusEl['textContent']='Download\x20wird\x20vorbereitet...';const o=new Blob([n]),p=document['createElement']('a');p['href']=URL['createObjectURL'](o),p['download']=e,p['click'](),statusEl['textContent']='✅\x20Download\x20abgeschlossen.';}catch(q){console['error']('Entschlüsselungsfehler:',q),progressBar['style']['width']='0%',statusEl['textContent']='❌\x20Entschlüsselung\x20fehlgeschlagen.';}}document['getElementById']('downloadButton')['addEventListener']('click',startDownload);